# Deployment Guide

## Railway (Full-Stack Application)

emarry uses Railway for hosting both backend and frontend in a single service.

### Prerequisites

- Railway account (https://railway.app)
- GitHub account (repository: pinion05/emarry)
- Google Cloud Project with OAuth 2.0 credentials
- OpenRouter API key

### Step 1: Create Railway Project

1. Go to [Railway](https://railway.app) and login
2. Click "New Project" → "Deploy from GitHub repo"
3. Select `pinion05/emarry` repository
4. Choose branch: `main`
5. Click "Deploy Now"

### Step 2: Add PostgreSQL Database

1. In your Railway project, click "New Service"
2. Select "Database" → "Add PostgreSQL"
3. Railway will automatically provide `DATABASE_URL`

### Step 3: Configure Environment Variables

Go to your project → "Variables" tab and add:

```bash
# Database (auto-generated by Railway)
DATABASE_URL=postgresql://postgres:password@host.railway.app:5432/railway

# Google OAuth (get from Google Cloud Console)
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_OAUTH_CALLBACK=https://your-app.railway.app/auth/google/callback

# Session Security
SESSION_SECRET=your-64-char-random-string-here

# Encryption (generate: openssl rand -hex 32)
ENCRYPTION_KEY=your-64-char-hex-key-here

# OpenRouter API (get from openrouter.ai)
OPENROUTER_API_KEY=sk-or-v1-your-api-key-here
OPENROUTER_MODEL=nvidia/nemotron-3-nano-30b-a3b:free

# App Configuration
PORT=3001
NODE_ENV=production
```

### Step 4: Run Database Migration

Railway의 "Console" 탭에서 다음 명령 실행:

```bash
cd backend && bun run migrate
```

### Step 5: Redeploy

1. Click "Deploy" button in Railway dashboard
2. Wait for deployment to complete
3. Your app will be available at: `https://your-app.railway.app`

### Step 6: Configure Google OAuth

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Navigate to APIs & Services → Credentials
3. Edit OAuth 2.0 client ID
4. Add to "Authorized redirect URIs":
   - `https://your-app.railway.app/auth/google/callback`
5. Save changes

### Deployment Verification

```bash
# Health check
curl https://your-app.railway.app/health

# Expected response
{"status":"ok","timestamp":"2026-02-05T..."}
```

### Monitoring

- **Logs**: Railway → "Deployments" → "View Logs"
- **Metrics**: Railway → "Metrics" tab
- **Database**: Railway → PostgreSQL service

### Rollback

If deployment fails:
1. Railway → "Deployments" tab
2. Click on previous successful deployment
3. Click "Rollback"

### Troubleshooting

**Database connection error:**
- Verify DATABASE_URL is correct
- Check PostgreSQL service is running

**OAuth callback error:**
- Verify GOOGLE_OAUTH_CALLBACK matches Railway URL exactly
- Check Google Cloud Console has correct redirect URI

**Cron jobs not running:**
- Check logs for errors
- Verify node-cron is running in server startup
